name: üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫

on:
  pull_request:
    types: [opened, ready_for_review, closed, reopened]

permissions:
  contents: read
  pull-requests: write
  repository-projects: write

jobs:
  move-project-card:
    runs-on: ubuntu-latest
    steps:
            - name: üìä –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å—Ç—É–¥–µ–Ω—Ç–∞
        uses: actions/github-script@v6
        with:
          script: |
            const automateProjectCard = async ({ github, context }) => {
              // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
              const PROJECT_NUMBER = 4;
              const OWNER = 'virusneo1997-del';
              const IS_ORGANIZATION = false;

              console.log('üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è PR:', context.payload.pull_request?.number);
              console.log(`–°–æ–±—ã—Ç–∏–µ: ${context.eventName}, –î–µ–π—Å—Ç–≤–∏–µ: ${context.payload.action}`);
              console.log(`–ê–≤—Ç–æ—Ä PR: ${context.payload.pull_request?.user?.login}`);

              try {
                // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–µ–º –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã
                console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ò—â–µ–º –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã...');
                const allProjectsQuery = `
                  query {
                    user(login: "${OWNER}") {
                      projectsV2(first: 20) {
                        nodes {
                          number
                          title
                          id
                          url
                        }
                      }
                    }
                  }
                `;
                
                try {
                  const allProjectsResult = await github.graphql(allProjectsQuery);
                  const projects = allProjectsResult.user.projectsV2.nodes;
                  console.log('üìã –í–°–ï –ü–†–û–ï–ö–¢–´ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:');
                  projects.forEach(project => {
                    console.log(`   ‚Ññ${project.number}: "${project.title}" (${project.id})`);
                  });
                  
                  if (projects.length === 0) {
                    console.log('‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤!');
                    return;
                  }
                  
                  // –ò—â–µ–º –ø—Ä–æ–µ–∫—Ç —Å –Ω–æ–º–µ—Ä–æ–º 4
                  const targetProject = projects.find(p => p.number === PROJECT_NUMBER);
                  if (targetProject) {
                    console.log(`‚úÖ –ü—Ä–æ–µ–∫—Ç ‚Ññ${PROJECT_NUMBER} –Ω–∞–π–¥–µ–Ω: "${targetProject.title}"`);
                  } else {
                    console.log(`‚ùå –ü—Ä–æ–µ–∫—Ç —Å –Ω–æ–º–µ—Ä–æ–º ${PROJECT_NUMBER} –Ω–µ –Ω–∞–π–¥–µ–Ω!`);
                    console.log(`üí° –î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–æ–º–µ—Ä–∞: ${projects.map(p => p.number).join(', ')}`);
                    return;
                  }
                } catch (error) {
                  console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø—Ä–æ–µ–∫—Ç–æ–≤:', error.message);
                  return;
                }

                // 1. –ü–æ–ª—É—á–∞–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥)
                const projectId = await getProjectId(github, OWNER, PROJECT_NUMBER, IS_ORGANIZATION);
                if (!projectId) {
                  console.log('‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                  return;
                }

                // –û–°–¢–ê–õ–¨–ù–û–ô –ö–û–î –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô...
                // 2. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª–µ Status
                const statusField = await getStatusField(github, projectId);
                if (!statusField) {
                  console.log('‚ùå –ü–æ–ª–µ Status –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                  return;
                }

                // 3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≤—Ç–æ—Ä–∞ PR
                const author = context.payload.pull_request?.user?.login;
                if (!author) {
                  console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ—Ä–∞ PR');
                  return;
                }

                // 4. –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É —Å—Ç—É–¥–µ–Ω—Ç–∞
                const studentCard = await findStudentCard(github, projectId, author);
                if (!studentCard) {
                  console.log(`‚ùå –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ ${author} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                  return;
                }

                // 5. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏—è PR
                const newStatus = await determineNewStatus(github, context, projectId, studentCard.id, statusField);
                if (!newStatus) {
                  console.log('‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è');
                  return;
                }

                // 6. –ù–∞—Ö–æ–¥–∏–º ID –æ–ø—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
                const statusOptionId = findStatusOptionId(statusField, newStatus);
                if (!statusOptionId) {
                  console.log(`‚ùå –û–ø—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ "${newStatus}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                  return;
                }

                // 7. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∏
                await updateCardStatus(github, projectId, studentCard.id, statusField.id, statusOptionId);
                
                console.log(`üéâ –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ ${author} –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ —Å—Ç–∞—Ç—É—Å: ${newStatus}`);

              } catch (error) {
                console.error('üí• –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏:', error);
              }
            };

            // –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            async function getProjectId(github, owner, projectNumber, isOrganization = false) {
              const entityType = isOrganization ? 'organization' : 'user';
              
              const query = `
                query {
                  ${entityType}(login: "${owner}") {
                    projectV2(number: ${projectNumber}) {
                      id
                      title
                    }
                  }
                }
              `;
              
              try {
                const result = await github.graphql(query);
                return result[entityType]?.projectV2?.id;
              } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø—Ä–æ–µ–∫—Ç–∞: ${error.message}`);
                throw error;
              }
            }

            // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (getStatusField, findStudentCard –∏ —Ç.–¥.)
