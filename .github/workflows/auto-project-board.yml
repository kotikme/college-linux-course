name: üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è Project Board

on:
  pull_request:
    types: [opened, reopened, ready_for_review, closed]
  pull_request_review:
    types: [submitted]

env:
  PROJECT_NUMBER: 4  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –Ω–æ–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ URL
  USER_LOGIN: virusneo1997-del  # –í–∞—à GitHub –ª–æ–≥–∏–Ω

jobs:
  automate-project:
    runs-on: ubuntu-latest
    steps:
      - name: üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
        uses: actions/github-script@v6
        with:
          # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ PAT –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Projects
          github-token: ${{ secrets.PROJECT_ACCESS_TOKEN }}
          script: |
            console.log('=== üöÄ –ó–ê–ü–£–°–ö –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò ===');
            
            const { pull_request } = context.payload;
            if (!pull_request) {
              console.log('‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ PR');
              return;
            }
            
            const author = pull_request.user.login;
            const prAction = context.payload.action;
            const prState = pull_request.state;
            const prMerged = pull_request.merged;
            const prTitle = pull_request.title;
            
            console.log(`üë§ –ê–≤—Ç–æ—Ä PR: ${author}`);
            console.log(`üîß –î–µ–π—Å—Ç–≤–∏–µ: ${prAction}`);
            console.log(`üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫: ${prTitle}`);
            console.log(`üîÑ –°—Ç–∞—Ç—É—Å PR: ${prState}`);
            console.log(`‚úÖ –ú–µ—Ä–∂: ${prMerged}`);
            
            // –û–ü–†–ï–î–ï–õ–Ø–ï–ú –ù–û–í–´–ô –°–¢–ê–¢–£–° –î–õ–Ø –ö–ê–†–¢–û–ß–ö–ò
            let newStatus = null;
            
            if (context.eventName === 'pull_request') {
              console.log(`üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ pull_request: ${prAction}`);
              
              switch (prAction) {
                case 'opened':
                  console.log('üéØ PR –æ—Ç–∫—Ä—ã—Ç - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º In Progress');
                  newStatus = 'In Progress';
                  break;
                  
                case 'reopened':
                  console.log('üéØ PR –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º In Progress');
                  newStatus = 'In Progress';
                  break;
                  
                case 'ready_for_review':
                  console.log('üéØ PR –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º In Review');
                  newStatus = 'In Review';
                  break;
                  
                case 'closed':
                  if (prMerged) {
                    console.log('üéØ PR –º–µ—Ä–∂–µ–Ω - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Done');
                    newStatus = 'Done';
                  } else {
                    console.log('üéØ PR –∑–∞–∫—Ä—ã—Ç –±–µ–∑ –º–µ—Ä–∂–∞ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º To do');
                    newStatus = 'To do';
                  }
                  break;
                  
                default:
                  console.log(`‚ÑπÔ∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${prAction}`);
              }
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π —Ä–µ–≤—å—é
            if (context.eventName === 'pull_request_review') {
              const reviewState = context.payload.review.state;
              console.log(`üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–≤—å—é: ${reviewState}`);
              
              if (reviewState === 'approved') {
                console.log('üéØ –†–µ–≤—å—é approved - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Done');
                newStatus = 'Done';
              }
            }
            
            if (!newStatus) {
              console.log('‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è');
              return;
            }
            
            console.log(`üéØ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: ${newStatus}`);
            
            try {
              // 1. –ü–û–õ–£–ß–ê–ï–ú ID –ü–†–û–ï–ö–¢–ê –ß–ï–†–ï–ó GRAPHQL
              const projectQuery = `
                query getProject($user: String!, $number: Int!) {
                  user(login: $user) {
                    projectV2(number: $number) {
                      id
                      title
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2Field {
                            id
                            name
                          }
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const projectResult = await github.graphql(projectQuery, {
                user: process.env.USER_LOGIN,
                number: process.env.PROJECT_NUMBER
              });
              
              const project = projectResult.user.projectV2;
              if (!project) {
                console.log('‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å PROJECT_NUMBER –∏ USER_LOGIN');
                return;
              }
              
              const projectId = project.id;
              console.log(`üìä –ù–∞–π–¥–µ–Ω –ø—Ä–æ–µ–∫—Ç: ${project.title} (ID: ${projectId})`);
              
              // 2. –ù–ê–•–û–î–ò–ú –ü–û–õ–ï STATUS
              const statusField = project.fields.nodes.find(field => field.name === 'Status');
              if (!statusField) {
                console.log('‚ùå –ü–æ–ª–µ Status –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ');
                console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è:', project.fields.nodes.map(f => f.name));
                return;
              }
              
              console.log(`üìã –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ Status: ${statusField.id}`);
              
              // 3. –ù–ê–•–û–î–ò–ú –û–ü–¶–ò–Æ –°–¢–ê–¢–£–°–ê
              const statusOption = statusField.options.find(option => option.name === newStatus);
              if (!statusOption) {
                console.log(`‚ùå –û–ø—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ '${newStatus}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏:', statusField.options.map(o => o.name));
                return;
              }
              
              console.log(`üìã –ù–∞–π–¥–µ–Ω–∞ –æ–ø—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${statusOption.name} (ID: ${statusOption.id})`);
              
              // 4. –ò–©–ï–ú –ö–ê–†–¢–û–ß–ö–£ –°–¢–£–î–ï–ù–¢–ê
              const itemsQuery = `
                query getProjectItems($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 50) {
                        nodes {
                          id
                          fieldValues(first: 10) {
                            nodes {
                              ... on ProjectV2ItemFieldTextValue {
                                field {
                                  ... on ProjectV2FieldCommon {
                                    name
                                  }
                                }
                                text
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const itemsResult = await github.graphql(itemsQuery, { projectId });
              const items = itemsResult.node.items.nodes;
              
              console.log(`üîç –ò—â–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞: ${author}`);
              
              // –ò—â–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ Student GitHub
              const studentItem = items.find(item => {
                const githubField = item.fieldValues.nodes.find(f => 
                  f.field && f.field.name === 'Student GitHub'
                );
                return githubField && githubField.text === author;
              });
              
              if (!studentItem) {
                console.log(`‚ùå –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ ${author} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç—É–¥–µ–Ω—Ç—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ:');
                items.forEach(item => {
                  const githubField = item.fieldValues.nodes.find(f => 
                    f.field && f.field.name === 'Student GitHub'
                  );
                  if (githubField) {
                    console.log(`- ${githubField.text}`);
                  }
                });
                return;
              }
              
              console.log(`üìé –ù–∞–π–¥–µ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞: ${studentItem.id}`);
              
              // 5. –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–£–° –ö–ê–†–¢–û–ß–ö–ò
              const updateMutation = `
                mutation updateProjectItem($input: UpdateProjectV2ItemFieldValueInput!) {
                  updateProjectV2ItemFieldValue(input: $input) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;
              
              const updateInput = {
                projectId,
                itemId: studentItem.id,
                fieldId: statusField.id,
                value: {
                  singleSelectOptionId: statusOption.id
                }
              };
              
              console.log('üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
              await github.graphql(updateMutation, { input: updateInput });
              
              console.log(`‚úÖ –£–°–ü–ï–•: –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ ${author} –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤: ${newStatus}`);
              
            } catch (error) {
              console.error('üí• –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏:', error);
              console.log('üîß –ü—Ä–æ–≤–µ—Ä—å: PROJECT_NUMBER, USER_LOGIN –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ PAT');
            }