name: Auto Project Board (v2)

on:
  pull_request_target:
    types: [opened, reopened, synchronize, closed]

permissions:
  contents: read
  pull-requests: write

jobs:
  sync-project:
    runs-on: ubuntu-latest
    steps:
      - name: Add or move PR to "In review"
        if: github.event.action != 'closed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_ACCESS_TOKEN }}
          script: |
            const { context } = require('@actions/github');

            const projectNumber = 7; // —Ç–≤–æ–π –ø—Ä–æ–µ–∫—Ç
            const columnName = "In review"; // –∫–æ–ª–æ–Ω–∫–∞ –≤ Project v2

            // 1Ô∏è‚É£ –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ PR (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const prId = pr.node_id;

            // 2Ô∏è‚É£ –ü–æ–ª—É—á–∞–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞
            const queryProject = `
              query($login: String!, $number: Int!) {
                user(login: $login) {
                  projectV2(number: $number) {
                    id
                  }
                }
              }`;

            const projectData = await github.graphql(queryProject, {
              login: "virusneo1997-del",
              number: projectNumber
            });

            const projectId = projectData.user.projectV2.id;

            // 3Ô∏è‚É£ –î–æ–±–∞–≤–ª—è–µ–º PR –≤ –ø—Ä–æ–µ–∫—Ç
            const addItem = `
              mutation($projectId: ID!, $prId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $prId}) {
                  item {
                    id
                  }
                }
              }`;

            const addResult = await github.graphql(addItem, {
              projectId: projectId,
              prId: prId
            });

            const itemId = addResult.addProjectV2ItemById.item.id;

            // 4Ô∏è‚É£ –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—è "Status"
            const fieldQuery = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    fields(first: 20) {
                      nodes {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }`;

            const fieldData = await github.graphql(fieldQuery, { projectId });
            const statusField = fieldData.node.fields.nodes.find(f => f.name === "Status");
            const column = statusField?.options?.find(o => o.name === columnName);

            if (!statusField || !column) {
              core.setFailed(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ "${columnName}" –≤ –ø–æ–ª–µ "Status"`);
              return;
            }

            // 5Ô∏è‚É£ –ü–µ—Ä–µ–º–µ—â–∞–µ–º PR –≤ –Ω—É–∂–Ω—É—é –∫–æ–ª–æ–Ω–∫—É
            const setStatus = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId,
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }`;

            await github.graphql(setStatus, {
              projectId,
              itemId,
              fieldId: statusField.id,
              optionId: column.id
            });

            console.log("‚úÖ PR –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–ª–æ–Ω–∫—É 'In review'");

      - name: Move to "To do" on close
        if: github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_ACCESS_TOKEN }}
          script: |
            const { context } = require('@actions/github');

            const projectNumber = 7;
            const columnName = "To do";

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ PR
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const prId = pr.node_id;

            // –ü–æ–ª—É—á–∞–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞
            const queryProject = `
              query($login: String!, $number: Int!) {
                user(login: $login) {
                  projectV2(number: $number) {
                    id
                  }
                }
              }`;

            const projectData = await github.graphql(queryProject, {
              login: "virusneo1997-del",
              number: projectNumber
            });

            const projectId = projectData.user.projectV2.id;

            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–µ "Status"
            const fieldQuery = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    fields(first: 20) {
                      nodes {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }`;

            const fieldData = await github.graphql(fieldQuery, { projectId });
            const statusField = fieldData.node.fields.nodes.find(f => f.name === "Status");
            const column = statusField?.options?.find(o => o.name === columnName);

            if (!statusField || !column) {
              core.setFailed(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ "${columnName}" –≤ –ø–æ–ª–µ "Status"`);
              return;
            }

            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –æ–±—Ä–∞—Ç–Ω–æ
            const setStatus = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId,
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }`;

            await github.graphql(setStatus, {
              projectId,
              itemId: prId,
              fieldId: statusField.id,
              optionId: column.id
            });

            console.log("üîÅ PR –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ 'To do'");
