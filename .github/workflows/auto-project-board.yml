name: üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è Project Board

on:
  pull_request:
    types: [opened, reopened, ready_for_review, closed, converted_to_draft]

env:
  USER_LOGIN: "virusneo1997-del"

jobs:
  automate-project:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      repository-projects: write
    steps:
      - name: üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_ACCESS_TOKEN }}
          script: |
            console.log('=== üöÄ –ó–ê–ü–£–°–ö –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò ===');

            // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
            if (!process.env.GITHUB_TOKEN || process.env.GITHUB_TOKEN.trim() === '') {
              console.log('‚ùå –û—à–∏–±–∫–∞: PROJECT_ACCESS_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω.');
              console.log('‚ÑπÔ∏è –î–æ–±–∞–≤—å—Ç–µ Secret –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret');
              console.log('   –ù–∞–∑–≤–∞–Ω–∏–µ: PROJECT_ACCESS_TOKEN');
              console.log('   –ó–Ω–∞—á–µ–Ω–∏–µ: –≤–∞—à Personal Access Token (classic) —Å –ø—Ä–∞–≤–∞–º–∏ repo, read/write project, read:user.');
              return;
            }
            console.log('‚úÖ PROJECT_ACCESS_TOKEN –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...');

            try {
              console.log('üîç –ò—â–µ–º –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
              const projectsQuery = `query {
                user(login: "${process.env.USER_LOGIN}") {
                  projectsV2(first: 10) {
                    nodes {
                      number
                      title
                      id
                      url
                    }
                  }
                }
              }`;

              const projectsResult = await github.graphql(projectsQuery);
              const projects = projectsResult.user.projectsV2.nodes;

              console.log('üìã –í–°–ï –ü–†–û–ï–ö–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:');
              projects.forEach((project, index) => {
                console.log(`${index + 1}. "${project.title}"`);
                console.log(`   –ù–æ–º–µ—Ä: ${project.number}`);
                console.log(`   ID: ${project.id}`);
                console.log(`   URL: ${project.url}`);
                console.log(`   ---`);
              });

              if (projects.length === 0) {
                console.log('‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤!');
                return;
              }

              // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç
              const targetProject = projects[0];
              console.log(`üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–µ–∫—Ç: "${targetProject.title}" (–Ω–æ–º–µ—Ä: ${targetProject.number})`);
              const projectId = targetProject.id;

              // –î–∞–ª—å—à–µ –≤—Å—è —Ç–≤–æ—è –ª–æ–≥–∏–∫–∞ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ üëá
              const { pull_request } = context.payload;
              if (!pull_request) {
                console.log('‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ PR');
                return;
              }

              const author = pull_request.user.login;
              const prAction = context.payload.action;
              const prState = pull_request.state;
              const prMerged = pull_request.merged;
              const prTitle = pull_request.title;
              const prDraft = pull_request.draft;

              console.log(`üë§ –ê–≤—Ç–æ—Ä PR: ${author}`);
              console.log(`üîß –î–µ–π—Å—Ç–≤–∏–µ: ${prAction}`);
              console.log(`üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫: ${prTitle}`);
              console.log(`üîÑ –°—Ç–∞—Ç—É—Å PR: ${prState}`);
              console.log(`‚úÖ –ú–µ—Ä–∂: ${prMerged}`);
              console.log(`üìù –ß–µ—Ä–Ω–æ–≤–∏–∫: ${prDraft}`);

              let newStatus = null;
              switch (prAction) {
                case 'opened':
                  newStatus = prDraft ? 'To do' : 'In Progress';
                  console.log(`üéØ PR –æ—Ç–∫—Ä—ã—Ç - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: ${newStatus}`);
                  break;
                case 'reopened':
                  newStatus = 'To do';
                  break;
                case 'ready_for_review':
                  newStatus = 'In Review';
                  break;
                case 'converted_to_draft':
                  newStatus = 'To do';
                  break;
                case 'closed':
                  newStatus = prMerged ? 'Done' : 'To do';
                  break;
                default:
                  console.log(`‚ÑπÔ∏è –ù–µ–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${prAction}`);
                  return;
              }

              console.log(`üéØ –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: ${newStatus}`);

              const projectDetailsQuery = `query GetProjectDetails($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    title
                    fields(first: 10) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options { id name }
                        }
                      }
                    }
                    items(first: 50) {
                      nodes {
                        id
                        fieldValues(first: 10) {
                          nodes {
                            ... on ProjectV2ItemFieldTextValue {
                              field { ... on ProjectV2FieldCommon { name } }
                              text
                            }
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              field { ... on ProjectV2FieldCommon { name } }
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }`;

              const projectDetails = await github.graphql(projectDetailsQuery, { projectId });
              const project = projectDetails.node;
              const statusField = project.fields.nodes.find(f => f.name === 'Status' && f.options);

              if (!statusField) {
                console.log('‚ùå –ü–æ–ª–µ Status –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.');
                return;
              }

              const statusOption = statusField.options.find(o => o.name === newStatus);
              if (!statusOption) {
                console.log(`‚ùå –û–ø—Ü–∏—è "${newStatus}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`);
                return;
              }

              let studentItem = project.items.nodes.find(item => {
                const githubField = item.fieldValues.nodes.find(f => f.field?.name === 'Student GitHub' && f.text);
                return githubField && githubField.text === author;
              });

              if (!studentItem) {
                console.log(`üÜï –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è ${author}...`);
                const studentGitHubField = project.fields.nodes.find(f => f.name === 'Student GitHub');
                if (!studentGitHubField) {
                  console.log('‚ùå –ü–æ–ª–µ Student GitHub –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.');
                  return;
                }

                const createItemMutation = `mutation ($input: AddProjectV2ItemByIdInput!) {
                  addProjectV2ItemById(input: $input) {
                    item { id }
                  }
                }`;

                const createResult = await github.graphql(createItemMutation, {
                  input: { projectId, contentId: pull_request.node_id }
                });

                const newItemId = createResult.addProjectV2ItemById.item.id;

                const updateGitHubMutation = `mutation ($input: UpdateProjectV2ItemFieldValueInput!) {
                  updateProjectV2ItemFieldValue(input: $input) {
                    projectV2Item { id }
                  }
                }`;

                await github.graphql(updateGitHubMutation, {
                  input: {
                    projectId,
                    itemId: newItemId,
                    fieldId: studentGitHubField.id,
                    value: { text: author }
                  }
                });

                console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω Student GitHub: ${author}`);
                studentItem = { id: newItemId };
              }

              const updateStatusMutation = `mutation ($input: UpdateProjectV2ItemFieldValueInput!) {
                updateProjectV2ItemFieldValue(input: $input) {
                  projectV2Item { id }
                }
              }`;

              await github.graphql(updateStatusMutation, {
                input: {
                  projectId,
                  itemId: studentItem.id,
                  fieldId: statusField.id,
                  value: { singleSelectOptionId: statusOption.id }
                }
              });

              console.log(`‚úÖ –£–°–ü–ï–•: ${author} –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ "${newStatus}"`);
            } catch (error) {
              console.error('üí• –û–®–ò–ë–ö–ê:', error.message);
              if (error.errors) {
                console.log('üìã GraphQL –æ—à–∏–±–∫–∏:', JSON.stringify(error.errors, null, 2));
              }
            }

            console.log('=== üèÅ –ó–ê–í–ï–†–®–ï–ù–ò–ï ===');
